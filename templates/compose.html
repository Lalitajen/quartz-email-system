{% extends "base.html" %}
{% block title %}Compose{% endblock %}

{% block content %}
<div class="page-header">
    <h2><i class="bi bi-pencil-square me-2"></i>Compose Email</h2>
</div>

<div class="row">
    <div class="col-md-5">
        <div class="card p-4">
            <h5><i class="bi bi-magic me-2"></i>Generate AI Email</h5>
            <form method="POST" action="/compose/generate">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="mb-3">
                    <label class="form-label">Customer *</label>
                    <select class="form-select" name="customer_id" required>
                        <option value="">Select a customer...</option>
                        {% for c in customers %}
                            {% set eng = c.get('engagement_level', '')|string|upper %}
                            {% set eng_tag = ' [' ~ eng ~ ']' if eng else '' %}
                            <option value="{{ c.get('id', '') }}" {{ 'selected' if c.get('id')|string == selected_id }}>
                                {{ c.get('company_name', '')|e }} - {{ c.get('contact_name', '')|e }}{{ eng_tag }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Pipeline Stage</label>
                    <select class="form-select" name="stage">
                        {% for num, info in pipeline_stages.items()|sort %}
                        <option value="{{ num }}">{{ num }} - {{ info.name }} ({{ info.attachments|join(', ') }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Additional Context <small class="text-muted">(optional)</small></label>
                    <textarea class="form-control" name="context" rows="3" placeholder="e.g. They recently expanded into solar manufacturing..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-stars me-1"></i>Generate Personalized Email
                </button>
            </form>
        </div>
        <div class="card p-4 mt-3">
            <h5><i class="bi bi-person-badge me-2"></i>Email Signature</h5>
            <hr>
            <div class="bg-light p-3 rounded" style="font-family: monospace; font-size: 0.9rem; white-space: pre-line;">Best regards,

{{ sender_name }}
{{ sender_title }}
{{ company_name }}{% if company_phone %}
Phone: {{ company_phone }}{% endif %}{% if company_website %}
Website: {{ company_website }}{% endif %}
{{ company_address }}</div>
            <small class="text-muted mt-2 d-block">Edit in <a href="/settings">Settings</a></small>
        </div>
    </div>
    <div class="col-md-7">
        {% if generated %}
        <div class="card p-4">
            <h5><i class="bi bi-envelope-open me-2"></i>Generated Email Preview</h5>
            <hr>
            <form method="POST" action="/compose/approve">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="customer_id" value="{{ gen_customer_id }}">
                <input type="hidden" name="stage" value="{{ gen_stage }}">
                <div class="mb-3">
                    <label class="form-label fw-bold">Subject</label>
                    <input type="text" class="form-control" name="subject" value="{{ generated.get('subject', '')|e }}">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Body</label>
                    <textarea class="form-control" name="body" rows="12">{{ generated.get('body', '')|e }}</textarea>
                </div>
                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label class="form-label fw-bold">Attachments</label>
                        <input type="text" class="form-control" name="attachments" value="{{ attachments_val }}">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-bold">Confidence</label>
                        <div class="form-control-plaintext">
                            <span class="badge bg-info fs-6">{{ generated.get('confidence_score', 'N/A') }}</span>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Schedule Send <small class="text-muted">(optional)</small></label>
                        <input type="date" class="form-control" name="scheduled_date" min="{{ today }}">
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-outline-primary"><i class="bi bi-check-lg me-1"></i>Queue Only</button>
                    <button type="submit" formaction="/compose/send_now" class="btn btn-success"><i class="bi bi-send me-1"></i>Send Now via Gmail</button>
                    <a href="/compose?id={{ gen_customer_id }}" class="btn btn-outline-secondary"><i class="bi bi-arrow-repeat me-1"></i>Regenerate</a>
                </div>
            </form>
        </div>
        {% else %}
        <div class="card p-5 text-center text-muted">
            <i class="bi bi-envelope" style="font-size:3rem;"></i>
            <p class="mt-3">Select a customer and click Generate to create a personalized AI email</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
