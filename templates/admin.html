{% extends "base.html" %}
{% block title %}Admin Panel{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <h2><i class="bi bi-shield-lock me-2"></i>Admin Panel</h2>
    <span class="badge bg-danger">Admin Only</span>
</div>

{% if error %}
<div class="alert alert-danger">
    <i class="bi bi-exclamation-triangle me-2"></i>{{ error }}
</div>
{% endif %}

<!-- Stats Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card stat-card text-center p-3">
            <div class="stat-icon text-primary"><i class="bi bi-people"></i></div>
            <div class="stat-value text-primary">{{ total_users }}</div>
            <div class="stat-label text-muted">Total Users</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card text-center p-3">
            <div class="stat-icon text-success"><i class="bi bi-check-circle"></i></div>
            <div class="stat-value text-success">{{ users|selectattr('setup_complete')|list|length }}</div>
            <div class="stat-label text-muted">Setup Complete</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card text-center p-3">
            <div class="stat-icon text-warning"><i class="bi bi-hourglass-split"></i></div>
            <div class="stat-value text-warning">{{ users|rejectattr('setup_complete')|list|length }}</div>
            <div class="stat-label text-muted">Pending Setup</div>
        </div>
    </div>
</div>

<!-- Users Table -->
<div class="card p-4">
    <h5 class="mb-3"><i class="bi bi-table me-2"></i>User Management</h5>

    {% if users %}
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Email</th>
                    <th>Display Name</th>
                    <th>Role</th>
                    <th>Setup Status</th>
                    <th>Joined</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
            {% for user in users %}
                <tr>
                    <td><code>{{ user.id }}</code></td>
                    <td>
                        <i class="bi bi-envelope me-1"></i>{{ user.email|e }}
                    </td>
                    <td>{{ user.display_name|e }}</td>
                    <td>
                        {% if user.role == 'admin' %}
                            <span class="badge bg-danger">
                                <i class="bi bi-shield-lock me-1"></i>Admin
                            </span>
                        {% else %}
                            <span class="badge bg-secondary">
                                <i class="bi bi-person me-1"></i>User
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.setup_complete %}
                            <span class="badge bg-success">
                                <i class="bi bi-check-circle me-1"></i>Complete
                            </span>
                        {% else %}
                            <span class="badge bg-warning">
                                <i class="bi bi-hourglass-split me-1"></i>Pending
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        <small class="text-muted">{{ user.created_at[:10] }}</small>
                    </td>
                    <td>
                        <a href="/admin/users/{{ user.id }}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-eye me-1"></i>View
                        </a>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center text-muted py-5">
        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
        <p class="mt-3">No users found.</p>
    </div>
    {% endif %}
</div>

<!-- System Info -->
<div class="card p-4 mt-4">
    <h5 class="mb-3"><i class="bi bi-info-circle me-2"></i>System Information</h5>
    <div class="row">
        <div class="col-md-6">
            <p><strong>Database:</strong> SQLite (quartz.db)</p>
            <p><strong>Encryption:</strong> Fernet (per-user credentials)</p>
            <p><strong>Authentication:</strong> Session-based with brute-force protection</p>
        </div>
        <div class="col-md-6">
            <p><strong>AI Model:</strong> Claude Sonnet 4</p>
            <p><strong>Multi-user Mode:</strong> <span class="badge bg-success">Enabled</span></p>
            <p><strong>Email Verification:</strong> <span class="badge bg-success">Enabled</span></p>
        </div>
    </div>
</div>

<style>
.stat-card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    transition: transform 0.2s;
}
.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.stat-icon {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}
.stat-value {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
}
.stat-label {
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
</style>
{% endblock %}
