{% extends "base.html" %}
{% block title %}{{ customer.get('company_name', 'Customer') }}{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <h2><i class="bi bi-building me-2"></i>{{ customer.get('company_name', '-')|e }}</h2>
    <a href="/customers" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left me-1"></i>Back to Customers</a>
</div>

<div class="row g-4">
    <!-- Customer Info -->
    <div class="col-md-4">
        <div class="card p-4 mb-3">
            <h5><i class="bi bi-person-badge me-2"></i>Contact Info</h5>
            <hr>
            <table class="table table-sm mb-0">
                <tr><td class="text-muted" width="40%">ID</td><td>{{ customer.get('id', '-') }}</td></tr>
                <tr><td class="text-muted">Contact</td><td>{{ customer.get('contact_name', '-')|e }}</td></tr>
                <tr><td class="text-muted">Email</td><td><a href="mailto:{{ customer.get('contact_email', '') }}">{{ customer.get('contact_email', '-')|e }}</a></td></tr>
                <tr><td class="text-muted">Department</td><td>{{ customer.get('contact_department', '-')|e }}</td></tr>
                <tr><td class="text-muted">Website</td><td>
                    {% if customer.get('company_website') %}
                        <a href="{{ customer.get('company_website') }}" target="_blank">{{ customer.get('company_website')|e }}</a>
                    {% else %}-{% endif %}
                </td></tr>
                <tr><td class="text-muted">Tags</td><td>
                    {% for tag in customer.get('tags', '')|string|split_comma %}
                        {% if tag %}<span class="badge bg-light text-dark me-1">{{ tag|e }}</span>{% endif %}
                    {% endfor %}
                    {% if not customer.get('tags') %}-{% endif %}
                </td></tr>
            </table>
        </div>

        <div class="card p-4 mb-3">
            <h5><i class="bi bi-graph-up me-2"></i>Sales Status</h5>
            <hr>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="text-muted">Pipeline Stage</span>
                {{ stage_badge(customer.get('pipeline_stage', '1')) }}
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="text-muted">Engagement</span>
                {{ engagement_badge(customer.get('engagement_level', '')|string|upper) }}
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="text-muted">Research</span>
                {% set rs = customer.get('research_status', 'pending') %}
                <span class="badge bg-{{ 'success' if rs == 'completed' else 'warning' }}">{{ rs }}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <span class="text-muted">Last Contact</span>
                <span>{{ customer.get('last_contact_date', '-') }}</span>
            </div>
        </div>

        {% if customer.get('buying_intent') or customer.get('urgency_score') or customer.get('next_action') %}
        <div class="card p-4 mb-3">
            <h5><i class="bi bi-robot me-2"></i>AI Insights</h5>
            <hr>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="text-muted">Buying Intent</span>
                {% set intent = customer.get('buying_intent', '')|string|lower %}
                <span class="badge bg-{{ 'danger' if intent == 'high' else 'warning text-dark' if intent == 'medium' else 'info' if intent == 'low' else 'secondary' }}">
                    {{ intent|upper or 'N/A' }}
                </span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="text-muted">Urgency Score</span>
                {% set urgency = customer.get('urgency_score', 0)|string %}
                {% set urg_int = urgency|int if urgency|string|replace('.','',1)|replace('-','',1) is mapping or urgency|int %}
                <span class="badge bg-{{ 'danger' if urgency|int >= 8 else 'warning text-dark' if urgency|int >= 5 else 'info' }}">
                    {{ urgency }}/10
                </span>
            </div>
            {% if customer.get('next_action') %}
            <div class="mb-2">
                <span class="text-muted d-block small">Recommended Action</span>
                <span class="fw-bold small">{{ customer.get('next_action', '')|e }}</span>
            </div>
            {% endif %}
            {% if customer.get('last_analyzed') %}
            <div class="text-muted small mt-1">
                <i class="bi bi-clock me-1"></i>Analyzed: {{ customer.get('last_analyzed', '') }}
            </div>
            {% endif %}
        </div>
        {% endif %}

        {% if customer.get('research_summary') %}
        <div class="card p-4 mb-3">
            <h5><i class="bi bi-search me-2"></i>Research Summary</h5>
            <hr>
            <p class="mb-2">{{ customer.get('research_summary', '')|e }}</p>
            {% if customer.get('pain_points') %}
            <strong class="small">Pain Points:</strong>
            <p class="small text-muted mb-0">{{ customer.get('pain_points', '')|e }}</p>
            {% endif %}
        </div>
        {% endif %}

        <div class="card p-4">
            <h5><i class="bi bi-lightning me-2"></i>Quick Actions</h5>
            <hr>
            <div class="d-grid gap-2">
                <a href="/research?id={{ customer.get('id', '') }}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-search me-1"></i>Research Company
                </a>
                <a href="/compose?id={{ customer.get('id', '') }}" class="btn btn-outline-success btn-sm">
                    <i class="bi bi-pencil me-1"></i>Compose Email
                </a>
                <form method="POST" action="/customers/{{ customer.get('id', '') }}/analyze" data-loading>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-outline-info btn-sm w-100">
                        <i class="bi bi-robot me-1"></i>AI Analyze
                    </button>
                </form>
                <button class="btn btn-outline-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editModal">
                    <i class="bi bi-pencil-square me-1"></i>Edit Customer
                </button>
                <form method="POST" action="/customers/{{ customer.get('id', '') }}/delete"
                      onsubmit="return confirm('Are you sure you want to delete this customer? This cannot be undone.')">
                    <button type="submit" class="btn btn-outline-danger btn-sm w-100">
                        <i class="bi bi-trash me-1"></i>Delete Customer
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Email History -->
    <div class="col-md-8">
        {% if duplicates %}
        <div class="alert alert-warning mb-3">
            <h6 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>Possible Duplicates Found ({{ duplicates|length }})</h6>
            <p class="small mb-2">The following customers share the same email or company name:</p>
            <div class="table-responsive">
                <table class="table table-sm mb-0">
                    <thead><tr><th>Company</th><th>Email</th><th>Match</th><th>Action</th></tr></thead>
                    <tbody>
                    {% for dup in duplicates %}
                        <tr>
                            <td>
                                <a href="/customers/{{ dup.customer.get('id', '') }}">
                                    {{ dup.customer.get('company_name', '-')|e }}
                                </a>
                            </td>
                            <td><small>{{ dup.customer.get('contact_email', '-')|e }}</small></td>
                            <td>
                                {% for reason in dup.reasons %}
                                    <span class="badge bg-warning text-dark">{{ reason }}</span>
                                {% endfor %}
                            </td>
                            <td>
                                <form method="POST" action="/customers/{{ dup.customer.get('id', '') }}/delete"
                                      class="d-inline"
                                      onsubmit="return confirm('Delete duplicate {{ dup.customer.get('company_name', '')|e }}? This cannot be undone.')">
                                    <button type="submit" class="btn btn-outline-danger btn-sm py-0">
                                        <i class="bi bi-trash"></i> Remove
                                    </button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <div class="card p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Email History</h5>
                <span class="badge bg-dark">{{ emails|length }} email(s)</span>
            </div>

            {% if emails %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr><th>Date</th><th>Subject</th><th>Stage</th><th>Type</th><th>Status</th><th>Reply</th></tr>
                    </thead>
                    <tbody>
                    {% for e in emails %}
                        {% set status = e.get('status', '-') %}
                        {% set status_colors = {'sent': 'success', 'queued': 'primary', 'draft': 'secondary', 'failed': 'danger', 'replied': 'info', 'followed_up': 'dark'} %}
                        {% set replied = e.get('replied', 'no') %}
                        {% set reply_summary = e.get('reply_content_summary', '')|string %}
                        <tr>
                            <td>
                                <small>{{ e.get('sent_date', '-') }}</small>
                                <br><small class="text-muted">{{ e.get('sent_time', '') }}</small>
                            </td>
                            <td><small>{{ e.get('subject', '-')|e|truncate(50) }}</small></td>
                            <td><span class="badge bg-secondary">{{ e.get('pipeline_stage', '-') }}</span></td>
                            <td><small>{{ e.get('email_type', 'outreach')|e }}</small></td>
                            <td><span class="badge bg-{{ status_colors.get(status, 'secondary') }}">{{ status }}</span></td>
                            <td>
                                {% if replied == 'yes' %}
                                    <span class="badge bg-success">Yes</span>
                                    {% if reply_summary.startswith('[') and ']' in reply_summary %}
                                        {% set rtype = reply_summary[1:reply_summary.index(']')] %}
                                        <br><small class="text-muted">{{ rtype }}</small>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center text-muted py-5">
                <i class="bi bi-envelope" style="font-size:2rem;"></i>
                <p class="mt-2">No emails sent to this customer yet</p>
                <a href="/compose?id={{ customer.get('id', '') }}" class="btn btn-success btn-sm">
                    <i class="bi bi-pencil me-1"></i>Compose First Email
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Edit Customer Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/customers/{{ customer.get('id', '') }}/edit">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Edit Customer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Company Name</label>
                            <input type="text" class="form-control" name="company_name" value="{{ customer.get('company_name', '')|e }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Contact Name</label>
                            <input type="text" class="form-control" name="contact_name" value="{{ customer.get('contact_name', '')|e }}">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Contact Email</label>
                            <input type="email" class="form-control" name="contact_email" value="{{ customer.get('contact_email', '')|e }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Company Website</label>
                            <input type="url" class="form-control" name="company_website" value="{{ customer.get('company_website', '')|e }}">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Department</label>
                            <input type="text" class="form-control" name="contact_department" value="{{ customer.get('contact_department', '')|e }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Pipeline Stage</label>
                            <select class="form-select" name="pipeline_stage">
                                {% for num, info in pipeline_stages.items()|sort %}
                                <option value="{{ num }}" {{ 'selected' if customer.get('pipeline_stage')|string == num|string }}>{{ num }} - {{ info.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Engagement Level</label>
                            <select class="form-select" name="engagement_level">
                                <option value="">Not Set</option>
                                {% for lvl in ['HOT', 'WARM', 'INTERESTED', 'COLD', 'UNRESPONSIVE'] %}
                                <option value="{{ lvl }}" {{ 'selected' if customer.get('engagement_level', '')|upper == lvl }}>{{ lvl }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tags</label>
                            <input type="text" class="form-control" name="tags" value="{{ customer.get('tags', '')|e }}">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="3">{{ customer.get('notes', '')|e }}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning"><i class="bi bi-check-lg me-1"></i>Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
