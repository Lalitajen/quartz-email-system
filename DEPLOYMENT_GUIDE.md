# Deployment Guide - Quartz Email System

**Version 3.1.0** - Production-Ready with OWASP Security

---

## ğŸš€ Quick Deploy to Render.com (Recommended)

### Prerequisites
- GitHub account with repository: `https://github.com/Lalitajen/quartz-email-system`
- Render.com account (free tier available)
- Your environment variables ready

### Step 1: Connect GitHub to Render

1. Go to [Render.com](https://render.com) and sign in
2. Click **"New +"** â†’ **"Blueprint"**
3. Connect your GitHub account if not already connected
4. Select repository: `Lalitajen/quartz-email-system`
5. Click **"Connect"**

### Step 2: Configure Environment Variables

Render will detect the `render.yaml` file. Add these environment variables:

#### Required Variables

```bash
# App Authentication
APP_USERNAME=your_admin_username
APP_PASSWORD=<use hashed password - see below>

# Google Services
GOOGLE_SHEETS_ID=your_google_sheets_id
SERVICE_ACCOUNT_B64=<base64 encoded service_account.json>
GMAIL_CREDENTIALS_B64=<base64 encoded gmail_credentials.json>
GMAIL_TOKEN_B64=<base64 encoded token.json>

# Anthropic AI
ANTHROPIC_API_KEY=sk-ant-your-key-here

# Sender Information
SENDER_NAME=Your Name
SENDER_EMAIL=you@company.com
SENDER_TITLE=Business Development Manager
COMPANY_NAME=Your Company
COMPANY_PHONE=+1-xxx-xxx-xxxx
COMPANY_WEBSITE=www.yourcompany.com
COMPANY_ADDRESS=Your Address

# Multi-User Admin (optional)
ADMIN_EMAIL=admin@yourcompany.com
```

#### Auto-Generated Variables (Render creates these)
- `FLASK_SECRET_KEY` - Auto-generated by Render
- `CREDENTIAL_ENCRYPTION_KEY` - Auto-generated by Render

### Step 3: Encode Credentials to Base64

Run these commands locally to encode your credential files:

```bash
# Service Account
base64 -i service_account.json | tr -d '\n' > service_account_b64.txt
cat service_account_b64.txt
# Copy output to SERVICE_ACCOUNT_B64 in Render

# Gmail Credentials
base64 -i gmail_credentials.json | tr -d '\n' > gmail_creds_b64.txt
cat gmail_creds_b64.txt
# Copy output to GMAIL_CREDENTIALS_B64 in Render

# Gmail Token
base64 -i token.json | tr -d '\n' > token_b64.txt
cat token_b64.txt
# Copy output to GMAIL_TOKEN_B64 in Render
```

### Step 4: Hash Your Password

```bash
python -c "from werkzeug.security import generate_password_hash; print(generate_password_hash('your_secure_password'))"
```

Copy the output to `APP_PASSWORD` in Render.

### Step 5: Deploy!

1. Click **"Apply"** in Render
2. Render will:
   - Build your Docker container
   - Deploy to production
   - Create persistent disk for SQLite database
   - Provide you with a URL: `https://quartz-email-system.onrender.com`

### Step 6: Verify Deployment

```bash
# Check if the app is running
curl https://quartz-email-system.onrender.com/login

# You should see the login page HTML
```

---

## ğŸ³ Alternative: Deploy with Docker

### Local Docker Build

```bash
# Build the image
docker build -t quartz-email-system .

# Run with environment variables
docker run -d \
  -p 5000:5000 \
  --env-file config/.env \
  --name quartz-app \
  quartz-email-system

# Access at http://localhost:5000
```

### Docker Compose (Coming Soon)

---

## â˜ï¸ Alternative: Deploy to AWS/GCP/Azure

### AWS Elastic Beanstalk

1. Install EB CLI:
   ```bash
   pip install awsebcli
   ```

2. Initialize:
   ```bash
   eb init -p docker quartz-email-system
   ```

3. Create environment:
   ```bash
   eb create quartz-prod
   ```

4. Set environment variables:
   ```bash
   eb setenv FLASK_ENV=production \
     ANTHROPIC_API_KEY=sk-ant-... \
     GOOGLE_SHEETS_ID=... \
     # ... (all other vars)
   ```

5. Deploy:
   ```bash
   eb deploy
   ```

### Google Cloud Run

```bash
# Build container
gcloud builds submit --tag gcr.io/PROJECT_ID/quartz-email-system

# Deploy
gcloud run deploy quartz-email-system \
  --image gcr.io/PROJECT_ID/quartz-email-system \
  --platform managed \
  --region us-central1 \
  --allow-unauthenticated \
  --set-env-vars FLASK_ENV=production,ANTHROPIC_API_KEY=sk-ant-...
```

### Azure Container Instances

```bash
# Create resource group
az group create --name quartz-rg --location eastus

# Deploy container
az container create \
  --resource-group quartz-rg \
  --name quartz-app \
  --image your-registry/quartz-email-system \
  --dns-name-label quartz-email \
  --ports 5000 \
  --environment-variables \
    FLASK_ENV=production \
    ANTHROPIC_API_KEY=sk-ant-...
```

---

## ğŸ”§ Production Configuration Checklist

Before deploying to production, ensure:

### Security
- [ ] `FLASK_ENV=production` set
- [ ] `FLASK_SECRET_KEY` is strong and unique (32+ bytes)
- [ ] `APP_PASSWORD` is hashed (not plaintext)
- [ ] All credentials are in environment variables (not in code)
- [ ] `.gitignore` includes all sensitive files
- [ ] HTTPS/TLS enabled (automatic on Render)
- [ ] Security headers enabled (automatic in v3.1.0)

### Performance
- [ ] Gunicorn with 2-4 workers
- [ ] 120s timeout configured
- [ ] Persistent disk for SQLite database
- [ ] Logs directory writable

### Monitoring
- [ ] Check logs: `tail -f logs/web_app.log`
- [ ] Set up error alerts (Render has built-in)
- [ ] Monitor rate limiting events

### Backups
- [ ] Regular database backups (SQLite in `/app/data`)
- [ ] Credential backups (encrypted, offline)

---

## ğŸ“Š Post-Deployment Verification

### 1. Health Check

```bash
# Visit your deployed URL
https://your-app.onrender.com/login

# Should see login page with:
# âœ… HTTPS enabled
# âœ… Security headers present
# âœ… No errors in browser console
```

### 2. Security Headers Check

```bash
curl -I https://your-app.onrender.com

# Should see:
# Content-Security-Policy: ...
# Strict-Transport-Security: max-age=31536000
# X-Frame-Options: DENY
# X-Content-Type-Options: nosniff
```

### 3. Login Test

```bash
# Try logging in with your credentials
# âœ… Should work with hashed password
# âœ… Should show "Welcome back!" message
# âœ… Session should persist for 2 hours
```

### 4. CSRF Test

```bash
# All forms should have CSRF tokens
# âœ… Login form has csrf_token field
# âœ… Settings form has csrf_token field
# âœ… All POST requests protected
```

### 5. Rate Limiting Test

```bash
# Try 6 failed logins in a row
# âœ… Should get locked out after 5 attempts
# âœ… Should see "Too many failed attempts" message
# âœ… Lockout should last 5 minutes
```

---

## ğŸ” Troubleshooting

### Issue: App won't start

**Check:**
- [ ] All environment variables set correctly
- [ ] Base64-encoded credentials are valid
- [ ] Dockerfile builds successfully locally

**Solution:**
```bash
# Test locally first
docker build -t quartz-test .
docker run -p 5000:5000 --env-file config/.env quartz-test
```

### Issue: Database errors

**Check:**
- [ ] Persistent disk mounted at `/app/data`
- [ ] SQLite database has write permissions
- [ ] Disk size >= 1GB

**Solution:**
```bash
# In Render dashboard:
# Services â†’ quartz-email-system â†’ Disks
# Ensure "quartz-data" is mounted at /app/data
```

### Issue: Gmail not working

**Check:**
- [ ] `GMAIL_TOKEN_B64` is valid and current
- [ ] Token hasn't expired
- [ ] Refresh token is included

**Solution:**
```bash
# Re-encode fresh token
base64 -i token.json | tr -d '\n'
# Update GMAIL_TOKEN_B64 in Render
```

### Issue: Rate limiting too strict

**Adjust in code:**
```python
# scripts/web_app.py, line 32
limiter = Limiter(key_func=get_remote_address,
                  default_limits=["500 per minute"])  # Increase limit
```

---

## ğŸ“ˆ Scaling Considerations

### Free Tier (Render)
- âœ… 750 hours/month free
- âœ… Automatic HTTPS
- âœ… 1GB persistent disk
- âš ï¸ Sleeps after 15 min inactivity
- âš ï¸ Limited to 512MB RAM

### Paid Tier ($7/month)
- âœ… No sleep
- âœ… 2GB RAM
- âœ… 10GB disk
- âœ… Better performance

### High Traffic ($25/month)
- âœ… 4GB RAM
- âœ… 50GB disk
- âœ… Horizontal scaling
- âœ… CDN integration

---

## ğŸ” Security Hardening for Production

### 1. Enable All Security Headers
Already included in v3.1.0!

### 2. Set Up SSL/TLS Pinning
Automatic on Render.com

### 3. Configure Firewall Rules
```bash
# Only allow HTTPS traffic
# Block all other ports except 443
```

### 4. Enable DDoS Protection
Use Cloudflare (free tier) in front of Render:
1. Sign up for Cloudflare
2. Add your domain
3. Point DNS to Render
4. Enable "Under Attack Mode" if needed

### 5. Regular Security Updates
```bash
# Update dependencies monthly
pip install --upgrade -r requirements.txt

# Check for vulnerabilities
pip install safety
safety check
```

---

## ğŸ“ Maintenance Tasks

### Weekly
- [ ] Check logs for errors
- [ ] Monitor rate limiting events
- [ ] Review failed login attempts

### Monthly
- [ ] Update dependencies
- [ ] Backup database
- [ ] Rotate credentials (if compromised)
- [ ] Review security logs

### Quarterly
- [ ] Security audit
- [ ] Performance optimization
- [ ] Update documentation

---

## ğŸ†˜ Support

- **Issues**: https://github.com/Lalitajen/quartz-email-system/issues
- **Documentation**: `USER_MANUAL.md`
- **Changelog**: `CHANGELOG.md`

---

## âœ… Deployment Complete!

Your OWASP-secure Quartz Email System is now live! ğŸ‰

**Next Steps:**
1. Test all features in production
2. Set up monitoring/alerts
3. Create first user account
4. Import customer data
5. Start sending emails!

---

**Version**: 3.1.0
**Last Updated**: 2026-02-13
**Status**: Production-Ready âœ…
